<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <title>{% block title %}PDV Sistema de Caixa{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/icon-192.png') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>üí∞ PDV-MF</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link {% if request.path == '/' %}active{% endif %}">
                    üè† Caixa
                </a>
                <a href="/historico" class="nav-link {% if request.path == '/historico' %}active{% endif %}">
                    üìä Hist√≥rico
                </a>
                <a href="/configuracoes" class="nav-link {% if request.path == '/configuracoes' %}active{% endif %}">
                    ‚öôÔ∏è Configura√ß√µes
                </a>
                <a href="/gerente" class="nav-link {% if request.path == '/gerente' %}active{% endif %}" title="Painel do Gerente">
                    üë§ Gerente
                </a>
            </div>
            <div class="nav-status">
                <div id="caixaStatus" class="status-badge">
                    <span class="status-dot"></span>
                    <span class="status-text">Carregando...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <p>PDV-MF &copy; 2026 - Sistema de Controle de Caixa</p>
        <p style="font-size: 0.7rem; color: #888; margin-top: 4px;">v1.0.2 - 09/01/2026 - iPad Otimizado</p>
    </footer>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>

    <!-- Polyfills para iOS 9/10 e navegadores antigos - v1.0.1 -->
    <script>
        // Polyfill para Promise (necessario para iOS 9)
        if (typeof Promise === 'undefined') {
            window.Promise = function(executor) {
                var self = this;
                self.state = 'pending';
                self.value = undefined;
                self.handlers = [];
                
                function resolve(value) {
                    if (self.state !== 'pending') return;
                    self.state = 'fulfilled';
                    self.value = value;
                    self.handlers.forEach(function(h) { h.onFulfilled(value); });
                }
                
                function reject(reason) {
                    if (self.state !== 'pending') return;
                    self.state = 'rejected';
                    self.value = reason;
                    self.handlers.forEach(function(h) { h.onRejected(reason); });
                }
                
                self.then = function(onFulfilled, onRejected) {
                    return new Promise(function(res, rej) {
                        function handle(value) {
                            try {
                                var result = onFulfilled ? onFulfilled(value) : value;
                                if (result && typeof result.then === 'function') {
                                    result.then(res, rej);
                                } else {
                                    res(result);
                                }
                            } catch (e) { rej(e); }
                        }
                        function handleErr(reason) {
                            try {
                                if (onRejected) {
                                    var result = onRejected(reason);
                                    res(result);
                                } else {
                                    rej(reason);
                                }
                            } catch (e) { rej(e); }
                        }
                        if (self.state === 'fulfilled') handle(self.value);
                        else if (self.state === 'rejected') handleErr(self.value);
                        else self.handlers.push({ onFulfilled: handle, onRejected: handleErr });
                    });
                };
                
                self.catch = function(onRejected) {
                    return self.then(null, onRejected);
                };
                
                try { executor(resolve, reject); } catch (e) { reject(e); }
            };
            
            Promise.resolve = function(value) {
                return new Promise(function(res) { res(value); });
            };
            
            Promise.reject = function(reason) {
                return new Promise(function(res, rej) { rej(reason); });
            };
        }
        
        // Polyfill para Object.keys
        if (!Object.keys) {
            Object.keys = function(obj) {
                var keys = [];
                for (var key in obj) {
                    if (obj.hasOwnProperty(key)) keys.push(key);
                }
                return keys;
            };
        }
        
        // Polyfill para Array.isArray
        if (!Array.isArray) {
            Array.isArray = function(arg) {
                return Object.prototype.toString.call(arg) === '[object Array]';
            };
        }
        
        // Polyfill para URLSearchParams
        if (typeof URLSearchParams === 'undefined') {
            window.URLSearchParams = function(init) {
                var self = this;
                self.params = {};
                if (init) {
                    if (typeof init === 'string') {
                        var pairs = init.replace(/^\?/, '').split('&');
                        for (var i = 0; i < pairs.length; i++) {
                            var pair = pairs[i].split('=');
                            if (pair[0]) {
                                self.params[decodeURIComponent(pair[0])] = decodeURIComponent(pair[1] || '');
                            }
                        }
                    } else if (typeof init === 'object') {
                        var keys = Object.keys(init);
                        for (var j = 0; j < keys.length; j++) {
                            self.params[keys[j]] = init[keys[j]];
                        }
                    }
                }
            };
            URLSearchParams.prototype.toString = function() {
                var self = this;
                var keys = Object.keys(self.params);
                var parts = [];
                for (var i = 0; i < keys.length; i++) {
                    var key = keys[i];
                    parts.push(encodeURIComponent(key) + '=' + encodeURIComponent(self.params[key]));
                }
                return parts.join('&');
            };
            URLSearchParams.prototype.get = function(name) {
                return this.params[name] || null;
            };
            URLSearchParams.prototype.set = function(name, value) {
                this.params[name] = value;
            };
        }
        
        // Polyfill para fetch (usando XMLHttpRequest)
        if (typeof fetch === 'undefined') {
            window.fetch = function(url, options) {
                options = options || {};
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    var method = options.method || 'GET';
                    var headers = options.headers || {};
                    
                    xhr.open(method, url, true);
                    
                    var headerKeys = Object.keys(headers);
                    for (var i = 0; i < headerKeys.length; i++) {
                        var key = headerKeys[i];
                        xhr.setRequestHeader(key, headers[key]);
                    }
                    
                    xhr.onload = function() {
                        var response = {
                            ok: xhr.status >= 200 && xhr.status < 300,
                            status: xhr.status,
                            statusText: xhr.statusText,
                            json: function() {
                                try {
                                    return Promise.resolve(JSON.parse(xhr.responseText));
                                } catch (e) {
                                    return Promise.reject(e);
                                }
                            },
                            text: function() {
                                return Promise.resolve(xhr.responseText);
                            }
                        };
                        resolve(response);
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('Network error'));
                    };
                    
                    xhr.ontimeout = function() {
                        reject(new Error('Timeout'));
                    };
                    
                    xhr.send(options.body || null);
                });
            };
        }
        
        // Polyfill para Element.classList em iOS antigo
        if (!('classList' in document.createElement('div'))) {
            Object.defineProperty(Element.prototype, 'classList', {
                get: function() {
                    var self = this;
                    return {
                        add: function(c) {
                            if (!self.className.match(new RegExp('(^|\\s)' + c + '(\\s|$)'))) {
                                self.className = self.className + ' ' + c;
                            }
                        },
                        remove: function(c) {
                            self.className = self.className.replace(new RegExp('(^|\\s)' + c + '(\\s|$)', 'g'), ' ').trim();
                        },
                        toggle: function(c) {
                            if (this.contains(c)) { this.remove(c); } else { this.add(c); }
                        },
                        contains: function(c) {
                            return self.className.match(new RegExp('(^|\\s)' + c + '(\\s|$)'));
                        }
                    };
                }
            });
        }
        
        console.log('PDV-MF v1.0.1 - Polyfills carregados');
    </script>

    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    {% block extra_js %}{% endblock %}
    
    <script>
        // Atualizar status do caixa no navbar (ES5 compat√≠vel)
        function atualizarStatusCaixa() {
            if (!window.API || !window.API.caixaStatus) {
                return;
            }
            
            API.caixaStatus()
                .then(function(status) {
                    var statusBadge = document.getElementById('caixaStatus');
                    if (!statusBadge) return;
                    
                    if (status.aberto) {
                        statusBadge.className = 'status-badge status-open';
                        statusBadge.querySelector('.status-text').textContent = 'Caixa Aberto';
                    } else {
                        statusBadge.className = 'status-badge status-closed';
                        statusBadge.querySelector('.status-text').textContent = 'Caixa Fechado';
                    }
                })
                .catch(function(error) {
                    console.error('Erro ao verificar status do caixa:', error);
                });
        }
        
        // Atualizar na primeira vez
        document.addEventListener('DOMContentLoaded', function() {
            atualizarStatusCaixa();
            setInterval(atualizarStatusCaixa, 30000);
        });
    </script>

    <!-- Registrar Service Worker (com prote√ß√£o para navegadores antigos) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registrado:', registration);
                    })
                    .catch(function(error) {
                        console.log('Erro ao registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
