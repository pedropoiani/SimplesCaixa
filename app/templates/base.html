<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}PDV Sistema de Caixa{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    {% block extra_css %}{% endblock %}
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>üí∞ PDV-MF</h1>
            </div>
            <div class="nav-menu">
                <a href="/" class="nav-link {% if request.path == '/' %}active{% endif %}">
                    üè† Caixa
                </a>
                <a href="/historico" class="nav-link {% if request.path == '/historico' %}active{% endif %}">
                    üìä Hist√≥rico
                </a>
                <a href="/configuracoes" class="nav-link {% if request.path == '/configuracoes' %}active{% endif %}">
                    ‚öôÔ∏è Configura√ß√µes
                </a>
                <a href="/gerente" class="nav-link {% if request.path == '/gerente' %}active{% endif %}" title="Painel do Gerente">
                    üë§ Gerente
                </a>
            </div>
            <div class="nav-status">
                <div id="caixaStatus" class="status-badge">
                    <span class="status-dot"></span>
                    <span class="status-text">Carregando...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="main-content">
        {% block content %}{% endblock %}
    </main>

    <footer class="footer">
        <p>PDV-MF &copy; 2026 - Sistema de Controle de Caixa</p>
    </footer>

    <!-- Modals Container -->
    <div id="modalsContainer"></div>

    <!-- Polyfill m√≠nimo para iOS 9 e navegadores antigos -->
    <script>
        // Polyfill para URLSearchParams
        if (!window.URLSearchParams) {
            window.URLSearchParams = function(init) {
                this.params = {};
                if (init) {
                    if (typeof init === 'string') {
                        init.split('&').forEach(function(pair) {
                            var parts = pair.split('=');
                            this.params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
                        }.bind(this));
                    } else if (typeof init === 'object') {
                        Object.keys(init).forEach(function(key) {
                            this.params[key] = init[key];
                        }.bind(this));
                    }
                }
            };
            window.URLSearchParams.prototype.toString = function() {
                return Object.keys(this.params).map(function(key) {
                    return encodeURIComponent(key) + '=' + encodeURIComponent(this.params[key]);
                }.bind(this)).join('&');
            };
        }
        
        // Polyfill simples para fetch (usando XMLHttpRequest)
        if (!window.fetch) {
            window.fetch = function(url, options) {
                options = options || {};
                return new Promise(function(resolve, reject) {
                    var xhr = new XMLHttpRequest();
                    var method = options.method || 'GET';
                    var headers = options.headers || {};
                    
                    xhr.open(method, url, true);
                    
                    Object.keys(headers).forEach(function(key) {
                        xhr.setRequestHeader(key, headers[key]);
                    });
                    
                    xhr.onload = function() {
                        resolve({
                            ok: xhr.status >= 200 && xhr.status < 300,
                            status: xhr.status,
                            json: function() {
                                try {
                                    return Promise.resolve(JSON.parse(xhr.responseText));
                                } catch (e) {
                                    return Promise.reject(e);
                                }
                            },
                            text: function() {
                                return Promise.resolve(xhr.responseText);
                            }
                        });
                    };
                    
                    xhr.onerror = function() {
                        reject(new Error('Network error'));
                    };
                    
                    xhr.send(options.body || null);
                });
            };
        }
    </script>

    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    {% block extra_js %}{% endblock %}
    
    <script>
        // Atualizar status do caixa no navbar (ES5 compat√≠vel)
        function atualizarStatusCaixa() {
            if (!window.API || !window.API.caixaStatus) {
                return;
            }
            
            API.caixaStatus()
                .then(function(status) {
                    var statusBadge = document.getElementById('caixaStatus');
                    if (!statusBadge) return;
                    
                    if (status.aberto) {
                        statusBadge.className = 'status-badge status-open';
                        statusBadge.querySelector('.status-text').textContent = 'Caixa Aberto';
                    } else {
                        statusBadge.className = 'status-badge status-closed';
                        statusBadge.querySelector('.status-text').textContent = 'Caixa Fechado';
                    }
                })
                .catch(function(error) {
                    console.error('Erro ao verificar status do caixa:', error);
                });
        }
        
        // Atualizar na primeira vez
        document.addEventListener('DOMContentLoaded', function() {
            atualizarStatusCaixa();
            setInterval(atualizarStatusCaixa, 30000);
        });
    </script>

    <!-- Registrar Service Worker (com prote√ß√£o para navegadores antigos) -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/static/js/sw.js')
                    .then(function(registration) {
                        console.log('Service Worker registrado:', registration);
                    })
                    .catch(function(error) {
                        console.log('Erro ao registrar Service Worker:', error);
                    });
            });
        }
    </script>
</body>
</html>
