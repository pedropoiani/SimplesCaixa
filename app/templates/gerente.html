<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a5fb4">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üìä Gerente - PDV-MF</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <style>
        /* Reset e Base Mobile */
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
        }
        
        /* Header Mobile */
        .mobile-header {
            background: linear-gradient(135deg, #1a5fb4, #0d4a8f);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 20px rgba(0,0,0,0.3);
        }
        
        .mobile-header h1 {
            margin: 0;
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .mobile-header .subtitle {
            font-size: 0.75rem;
            opacity: 0.8;
            margin-top: 0.25rem;
        }
        
        .header-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .header-btn {
            flex: 1;
            padding: 0.6rem;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
        }
        
        .header-btn.primary {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        
        .header-btn.success {
            background: #26a269;
            color: white;
        }
        
        .header-btn.danger {
            background: #c01c28;
            color: white;
        }

        .filtro-data {
            margin-top: 0.75rem;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.15);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .filtro-data label {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            font-weight: 600;
        }

        .filtro-data input {
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 8px;
            color: white;
            font-size: 0.9rem;
            padding: 0.45rem 0.75rem;
            max-width: 160px;
            width: 100%;
        }

        .filtro-data input::-webkit-calendar-picker-indicator {
            filter: invert(1);
        }

        /* Calend√°rio Visual de Datas */
        .calendario-visual {
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            display: flex;
            gap: 0.35rem;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .calendario-visual::-webkit-scrollbar {
            height: 4px;
        }

        .calendario-visual::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        .dia-calendario {
            min-width: 32px;
            height: 42px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            background: rgba(255,255,255,0.05);
            border: 1px solid transparent;
        }

        .dia-calendario:hover {
            background: rgba(255,255,255,0.1);
        }

        .dia-calendario.hoje {
            border-color: #1a5fb4;
            background: rgba(26, 95, 180, 0.2);
        }

        .dia-calendario.selecionado {
            background: #1a5fb4;
            font-weight: 700;
        }

        .dia-calendario .dia-num {
            font-weight: 600;
            color: white;
        }

        .dia-calendario .dia-nome {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.6);
            margin-bottom: 2px;
        }

        .dia-calendario.com-movimento::after {
            content: '';
            position: absolute;
            bottom: 3px;
            width: 4px;
            height: 4px;
            background: #1a5fb4;
            border-radius: 50%;
            box-shadow: 0 0 4px #1a5fb4;
        }

        .dia-calendario.selecionado.com-movimento::after {
            background: #26a269;
            box-shadow: 0 0 4px #26a269;
        }
        
        /* Status do Caixa */
        .caixa-status-card {
            margin: 1rem;
            padding: 1rem;
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .caixa-status-card.aberto {
            background: linear-gradient(135deg, rgba(38, 162, 105, 0.2), rgba(38, 162, 105, 0.1));
            border-color: #26a269;
        }
        
        .caixa-status-card.fechado {
            background: linear-gradient(135deg, rgba(192, 28, 40, 0.2), rgba(192, 28, 40, 0.1));
            border-color: #c01c28;
        }
        
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .status-badge {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        .status-dot.aberto { background: #26a269; }
        .status-dot.fechado { background: #c01c28; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.7; transform: scale(1.1); }
        }
        
        /* Cards de Resumo */
        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem;
        }
        
        .resumo-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .resumo-card.destaque {
            grid-column: span 2;
            background: linear-gradient(135deg, #1a5fb4, #0d4a8f);
            border: none;
        }
        
        .resumo-card .label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: rgba(255,255,255,0.7);
            margin-bottom: 0.5rem;
        }
        
        .resumo-card .valor {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .resumo-card.destaque .valor {
            font-size: 2rem;
        }
        
        .resumo-card.positivo .valor { color: #26a269; }
        .resumo-card.negativo .valor { color: #c01c28; }
        
        /* Vendas por Forma */
        .vendas-forma {
            margin: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 1rem;
        }
        
        .vendas-forma h3 {
            margin: 0 0 0.75rem 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .forma-item {
            display: flex;
            justify-content: space-between;
            padding: 0.6rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .forma-item:last-child {
            border-bottom: none;
        }
        
        .forma-nome {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }
        
        .forma-valor {
            font-weight: 600;
            color: #26a269;
        }
        
        /* √öltimas Movimenta√ß√µes */
        .movimentacoes {
            margin: 1rem;
        }
        
        .movimentacoes h3 {
            margin: 0 0 0.75rem 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .mov-item {
            background: rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 0.75rem;
        }
        
        .mov-item.entrada {
            border-left: 3px solid #26a269;
        }
        
        .mov-item.saida {
            border-left: 3px solid #c01c28;
        }
        
        .mov-info {
            flex: 1;
        }
        
        .mov-categoria {
            font-weight: 600;
            font-size: 0.85rem;
        }
        
        .mov-descricao {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            margin-top: 0.15rem;
        }
        
        .mov-hora {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.5);
        }
        
        .mov-valor {
            font-weight: 700;
            font-size: 1rem;
        }
        
        .mov-valor.entrada { color: #26a269; }
        .mov-valor.saida { color: #c01c28; }

        .mov-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.35rem;
        }

        .mov-estorno {
            font-size: 0.7rem;
            color: rgba(255,255,255,0.6);
            margin-top: 0.35rem;
        }

        .estornar-btn {
            border: none;
            border-radius: 999px;
            background: rgba(255,255,255,0.12);
            color: white;
            padding: 0.35rem 0.95rem;
            font-size: 0.65rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .estornar-btn:hover {
            background: rgba(255,255,255,0.25);
        }
        
        /* Gr√°fico Semanal Simples */
        .grafico-semana {
            margin: 1rem;
            background: rgba(255,255,255,0.05);
            border-radius: 15px;
            padding: 1rem;
        }
        
        .grafico-semana h3 {
            margin: 0 0 1rem 0;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .barras {
            display: flex;
            align-items: flex-end;
            gap: 0.5rem;
            height: 120px;
        }
        
        .barra-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }
        
        .barra {
            width: 100%;
            background: linear-gradient(to top, #1a5fb4, #26a269);
            border-radius: 5px 5px 0 0;
            min-height: 5px;
            transition: height 0.3s;
        }
        
        .barra-label {
            font-size: 0.65rem;
            margin-top: 0.35rem;
            color: rgba(255,255,255,0.7);
        }
        
        .barra-valor {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.5);
            margin-top: 0.15rem;
        }
        
        /* Bot√µes de A√ß√£o */
        .acoes-rapidas {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin: 1rem;
        }
        
        .acao-btn {
            padding: 1rem;
            border: none;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }
        
        .acao-btn span:first-child {
            font-size: 1.5rem;
        }
        
        .acao-btn.pdf {
            background: linear-gradient(135deg, #e66100, #c64b00);
            color: white;
        }
        
        .acao-btn.refresh {
            background: linear-gradient(135deg, #1a5fb4, #0d4a8f);
            color: white;
        }
        
        .acao-btn.voltar {
            background: rgba(255,255,255,0.1);
            color: white;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 2rem;
            color: rgba(255,255,255,0.5);
        }
        
        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255,255,255,0.2);
            border-top-color: #1a5fb4;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Footer */
        .mobile-footer {
            text-align: center;
            padding: 1.5rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
        }
        
        /* Notifica√ß√£o Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            font-size: 0.85rem;
            z-index: 1000;
            animation: slideUp 0.3s, fadeOut 0.3s 2.7s;
        }
        
        .toast.success { background: #26a269; }
        .toast.error { background: #c01c28; }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        @keyframes fadeOut {
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="mobile-header">
        <h1>üìä Painel do Gerente</h1>
        <div class="subtitle" id="dataAtual"></div>
        <div class="header-actions">
            <button class="header-btn primary" onclick="atualizarDados()">üîÑ Atualizar</button>
            <button class="header-btn success" onclick="baixarPDF()">üì• PDF</button>
            <a href="/" class="header-btn danger" style="text-decoration: none;">üè† Caixa</a>
        </div>
        <div class="filtro-data">
            <label for="filtroData">üìÖ Filtrar por data</label>
            <input type="date" id="filtroData">
            <div class="calendario-visual" id="calendarioVisual">
                <!-- Preenchido via JavaScript -->
            </div>
        </div>
    </header>
    
    <!-- Status do Caixa -->
    <div id="caixaStatusCard" class="caixa-status-card">
        <div class="loading">
            <div class="loading-spinner"></div>
            Carregando...
        </div>
    </div>
    
    <!-- Resumo do Dia -->
    <div class="resumo-grid" id="resumoGrid">
        <!-- Preenchido via JS -->
    </div>
    
    <!-- Vendas por Forma -->
    <div class="vendas-forma" id="vendasForma">
        <h3>üí≥ Vendas por Forma de Pagamento</h3>
        <div id="formasPagamento">
            <div class="loading">Carregando...</div>
        </div>
    </div>
    
    <!-- Gr√°fico Semanal -->
    <div class="grafico-semana">
        <h3>üìà √öltimos 7 Dias</h3>
        <div class="barras" id="graficoSemana">
            <div class="loading">Carregando...</div>
        </div>
    </div>
    
    <!-- √öltimas Movimenta√ß√µes -->
    <div class="movimentacoes">
        <h3>üìã √öltimas Movimenta√ß√µes</h3>
        <div id="listaMovimentacoes">
            <div class="loading">Carregando...</div>
        </div>
    </div>
    
    <!-- A√ß√µes R√°pidas -->
    <div class="acoes-rapidas">
        <button class="acao-btn pdf" onclick="baixarPDF()">
            <span>üìÑ</span>
            <span>Baixar PDF</span>
        </button>
    </div>
    
    <!-- Footer -->
    <footer class="mobile-footer">
        <p>PDV-MF ¬© 2026 - Painel do Gerente</p>
        <p>√öltima atualiza√ß√£o: <span id="ultimaAtualizacao">--</span></p>
    </footer>
    
    <script>
        // ===== VARI√ÅVEIS GLOBAIS =====
        let dadosResumo = null;
        let filtroDataInput = null;
        let datasComMovimento = new Set();
        
        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', async () => {
            const hoje = new Date();
            const isoHoje = hoje.toISOString().split('T')[0];

            filtroDataInput = document.getElementById('filtroData');
            if (filtroDataInput) {
                filtroDataInput.value = isoHoje;
                filtroDataInput.addEventListener('change', atualizarDados);
            }

            document.getElementById('dataAtual').textContent = 'Carregando resumo...';

            await Promise.all([
                atualizarDados(),
                carregarDatasComMovimento()
            ]);

            setInterval(atualizarDados, 30000);
        });
        
        // ===== FUN√á√ïES DE DADOS =====
        async function carregarDatasComMovimento() {
            try {
                const response = await fetch('/api/gerente/datas-com-movimento');
                const data = await response.json();
                
                if (data.success && data.datas) {
                    datasComMovimento = new Set(data.datas);
                    renderizarCalendarioVisual();
                }
            } catch (error) {
                console.error('Erro ao carregar datas:', error);
            }
        }

        function renderizarCalendarioVisual() {
            const container = document.getElementById('calendarioVisual');
            const hoje = new Date();
            const dataSelecionada = filtroDataInput?.value || hoje.toISOString().split('T')[0];
            
            // √öltimos 14 dias
            const dias = [];
            for (let i = 13; i >= 0; i--) {
                const data = new Date(hoje);
                data.setDate(data.getDate() - i);
                dias.push(data);
            }
            
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            
            container.innerHTML = dias.map(data => {
                const dataISO = data.toISOString().split('T')[0];
                const ehHoje = dataISO === hoje.toISOString().split('T')[0];
                const ehSelecionado = dataISO === dataSelecionada;
                const temMovimento = datasComMovimento.has(dataISO);
                
                const classes = [
                    'dia-calendario',
                    ehHoje ? 'hoje' : '',
                    ehSelecionado ? 'selecionado' : '',
                    temMovimento ? 'com-movimento' : ''
                ].filter(Boolean).join(' ');
                
                return `
                    <div class="${classes}" onclick="selecionarData('${dataISO}')">
                        <div class="dia-nome">${diasSemana[data.getDay()]}</div>
                        <div class="dia-num">${data.getDate()}</div>
                    </div>
                `;
            }).join('');
        }

        function selecionarData(dataISO) {
            if (filtroDataInput) {
                filtroDataInput.value = dataISO;
                atualizarDados();
                renderizarCalendarioVisual();
            }
        }
        
        async function atualizarDados() {
            const dataSelecionada = filtroDataInput?.value || new Date().toISOString().split('T')[0];
            try {
                await Promise.all([
                    carregarResumoDia(dataSelecionada),
                    carregarSemana(),
                    carregarMovimentacoes()
                ]);
                
                document.getElementById('ultimaAtualizacao').textContent = 
                    new Date().toLocaleTimeString('pt-BR');
                    
            } catch (error) {
                console.error('Erro ao atualizar dados:', error);
                mostrarToast('Erro ao carregar dados', 'error');
            }
        }
        
        async function carregarResumoDia(dataSelecionada) {
            const dataParaBuscar = dataSelecionada || new Date().toISOString().split('T')[0];
            const params = new URLSearchParams({ data: dataParaBuscar });
            const response = await fetch(`/api/gerente/resumo-hoje?${params.toString()}`);
            const payload = await response.json();
            
            if (payload.success) {
                dadosResumo = payload;
                renderizarStatus(payload);
                renderizarResumo(payload);
                renderizarFormasPagamento(payload.vendas);
                const dataIso = payload.data || (payload.periodo && payload.periodo.data) || dataParaBuscar;
                atualizarEtiquetaData(dataIso);
            }
        }
        
        async function carregarSemana() {
            const response = await fetch('/api/gerente/resumo-semana');
            const data = await response.json();
            
            if (data.success) {
                renderizarGrafico(data.dias);
            }
        }
        
        async function carregarMovimentacoes() {
            const response = await fetch('/api/gerente/ultimas-movimentacoes?limite=10');
            const data = await response.json();
            
            if (data.success) {
                renderizarMovimentacoes(data.lancamentos);
            }
        }
        
        // ===== FUN√á√ïES DE RENDERIZA√á√ÉO =====
        function renderizarStatus(data) {
            const card = document.getElementById('caixaStatusCard');
            const aberto = data.caixa_aberto;
            
            card.className = `caixa-status-card ${aberto ? 'aberto' : 'fechado'}`;
            card.innerHTML = `
                <div class="status-header">
                    <div class="status-badge">
                        <span class="status-dot ${aberto ? 'aberto' : 'fechado'}"></span>
                        <span>Caixa ${aberto ? 'ABERTO' : 'FECHADO'}</span>
                    </div>
                    <span>${aberto && data.caixa_atual ? data.caixa_atual.operador || 'Sem operador' : ''}</span>
                </div>
                ${aberto && data.caixa_atual ? `
                    <div style="font-size: 0.8rem; color: rgba(255,255,255,0.7);">
                        Aberto √†s ${new Date(data.caixa_atual.data_abertura).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'})}
                        ‚Ä¢ Troco: ${formatarMoeda(data.caixa_atual.troco_inicial)}
                    </div>
                ` : ''}
            `;
        }
        
        function renderizarResumo(data) {
            const grid = document.getElementById('resumoGrid');
            
            grid.innerHTML = `
                <div class="resumo-card destaque">
                    <div class="label">üí∞ Total de Vendas Hoje</div>
                    <div class="valor">${formatarMoeda(data.total_vendas)}</div>
                </div>
                <div class="resumo-card positivo">
                    <div class="label">üíµ Saldo final em dinheiro</div>
                    <div class="valor">${formatarMoeda(data.saldo_final_dinheiro)}</div>
                </div>
                <div class="resumo-card positivo">
                    <div class="label">üì¶ Qtd. Lan√ßamentos</div>
                    <div class="valor">${data.qtd_lancamentos}</div>
                </div>
                <div class="resumo-card">
                    <div class="label">üìÇ Caixas Hoje</div>
                    <div class="valor">${data.qtd_caixas}</div>
                </div>
                <div class="resumo-card positivo">
                    <div class="label">‚¨ÜÔ∏è Suprimentos</div>
                    <div class="valor">${formatarMoeda(data.movimentacoes.suprimentos)}</div>
                </div>
                <div class="resumo-card negativo">
                    <div class="label">‚¨áÔ∏è Sangrias</div>
                    <div class="valor">${formatarMoeda(data.movimentacoes.sangrias)}</div>
                </div>
            `;
        }
        
        function renderizarFormasPagamento(vendas) {
            const container = document.getElementById('formasPagamento');
            
            const formas = [
                { nome: 'Dinheiro', emoji: 'üíµ', valor: vendas.dinheiro },
                { nome: 'PIX', emoji: 'üì±', valor: vendas.pix },
                { nome: 'Cart√£o Cr√©dito', emoji: 'üí≥', valor: vendas.cartao_credito },
                { nome: 'Cart√£o D√©bito', emoji: 'üí≥', valor: vendas.cartao_debito }
            ].filter(f => f.valor > 0);
            
            if (formas.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 1rem;">Nenhuma venda hoje</div>';
                return;
            }
            
            container.innerHTML = formas.map(f => `
                <div class="forma-item">
                    <span class="forma-nome">${f.emoji} ${f.nome}</span>
                    <span class="forma-valor">${formatarMoeda(f.valor)}</span>
                </div>
            `).join('');
        }
        
        function renderizarGrafico(dias) {
            const container = document.getElementById('graficoSemana');
            const maxValor = Math.max(...dias.map(d => d.total), 1);
            
            const diasSemana = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'S√°b'];
            
            container.innerHTML = dias.map(d => {
                const altura = (d.total / maxValor) * 100;
                const data = new Date(d.data + 'T12:00:00');
                const diaSemana = diasSemana[data.getDay()];
                
                return `
                    <div class="barra-container">
                        <div class="barra" style="height: ${Math.max(altura, 5)}%;"></div>
                        <div class="barra-label">${diaSemana}</div>
                        <div class="barra-valor">${formatarMoedaCurto(d.total)}</div>
                    </div>
                `;
            }).join('');
        }
        
        function renderizarMovimentacoes(lancamentos) {
            const container = document.getElementById('listaMovimentacoes');
            
            if (lancamentos.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: rgba(255,255,255,0.5); padding: 1rem;">Nenhuma movimenta√ß√£o</div>';
                return;
            }
            
            container.innerHTML = lancamentos.map(l => {
                const hora = new Date(l.data_hora).toLocaleTimeString('pt-BR', {hour: '2-digit', minute: '2-digit'});
                const emoji = l.categoria === 'venda' ? 'üõí' : 
                             l.categoria === 'sangria' ? 'üí∏' : 
                             l.categoria === 'suprimento' ? 'üí∞' : 'üìã';
                const estornado = Boolean(l.estornado);
                const motivoEstorno = estornado ? `<div class="mov-estorno">Estornada ‚Ä¢ ${l.motivo_estorno || 'Motivo n√£o informado'}</div>` : '';
                const acaoEstorno = l.categoria === 'venda' && !estornado
                    ? `<button type="button" class="estornar-btn" onclick="confirmarEstorno(${l.id})">Estornar</button>`
                    : '';
                
                return `
                    <div class="mov-item ${l.tipo}">
                        <div class="mov-info">
                            <div class="mov-categoria">${emoji} ${l.categoria.charAt(0).toUpperCase() + l.categoria.slice(1)}</div>
                            <div class="mov-descricao">${l.descricao || l.forma_pagamento || '-'}</div>
                            ${motivoEstorno}
                            <div class="mov-hora">${hora}</div>
                        </div>
                        <div class="mov-right">
                            <div class="mov-valor ${l.tipo}">
                                ${l.tipo === 'saida' ? '-' : '+'}${formatarMoeda(l.valor)}
                            </div>
                            ${acaoEstorno}
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function confirmarEstorno(lancamentoId) {
            const motivo = prompt('Informe o motivo do estorno (obrigat√≥rio):');
            if (!motivo || !motivo.trim()) {
                mostrarToast('Motivo do estorno √© obrigat√≥rio', 'error');
                return;
            }

            try {
                const response = await fetch('/api/gerente/estornar-venda', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lancamento_id: lancamentoId,
                        motivo: motivo.trim()
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarToast('Venda estornada com sucesso', 'success');
                    await atualizarDados();
                } else {
                    mostrarToast(data.message || 'N√£o foi poss√≠vel estornar', 'error');
                }
            } catch (error) {
                console.error('Erro ao estornar venda:', error);
                mostrarToast('Erro ao estornar venda', 'error');
            }
        }

        function atualizarEtiquetaData(dataISO) {
            if (!dataISO) return;
            const label = document.getElementById('dataAtual');
            const data = criarDataLocal(dataISO);
            const descricao = data.toLocaleDateString('pt-BR', { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' });
            label.textContent = `Resumo para ${descricao}`;
        }

        function criarDataLocal(dataISO) {
            if (!dataISO) {
                return new Date();
            }
            const partes = dataISO.split('-');
            if (partes.length < 3) {
                return new Date(dataISO);
            }
            const dia = partes[2].split('T')[0];
            return new Date(Number(partes[0]), Number(partes[1]) - 1, Number(dia));
        }
        
        // ===== FUN√á√ïES DE PDF =====
        function baixarPDF() {
            const dataSelecionada = filtroDataInput?.value || new Date().toISOString().split('T')[0];
            window.open(`/api/relatorio/resumo-diario/pdf?data=${dataSelecionada}`, '_blank');
        }
        
        // ===== UTILIDADES =====
        function formatarMoeda(valor) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(valor || 0);
        }
        
        function formatarMoedaCurto(valor) {
            if (valor >= 1000) {
                return (valor / 1000).toFixed(1) + 'k';
            }
            return valor.toFixed(0);
        }
        
        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            toast.textContent = mensagem;
            document.body.appendChild(toast);
            
            setTimeout(() => toast.remove(), 3000);
        }
    </script>
</body>
</html>
